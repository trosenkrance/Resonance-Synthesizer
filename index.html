<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Soundscape Studio — Piano + Binaural + Drums</title>
  <meta name="theme-color" content="#081229">
  <link rel="manifest" href="data:application/manifest+json,{
    %22name%22:%22Soundscape%20Studio%22,
    %22short_name%22:%22Soundscape%22,
    %22start_url%22:%22.%22,
    %22display%22:%22standalone%22,
    %22background_color%22:%22#081229%22,
    %22theme_color%22:%22#3b82f6%22,
    %22icons%22:[{%22src%22:%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%233b82f6'/%3E%3Cpath d='M30 40 L40 30 L50 50 L60 30 L70 40' stroke='%23fff' stroke-width='6' fill='none'/%3E%3C/svg%3E%22,%22sizes%22:%22192x192%22,%22type%22:%22image/svg+xml%22}]
  }">
  <style>
    :root{
      --bg1:#081229;--bg2:#1e3a8a;--panel:rgba(255,255,255,0.04);--muted:rgba(255,255,255,0.7);
      --accent:#3b82f6;--accent2:#10b981;--danger:#ef4444;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;overflow-x:hidden}
    body{
      font-family:Inter,system-ui,-apple-system,sans-serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      color:#fff;padding:12px;-webkit-user-select:none;user-select:none;
    }
    .container{max-width:1100px;margin:0 auto}
    h1{font-size:1.25rem;text-align:center;margin-bottom:10px}
    .panel{background:var(--panel);border-radius:10px;padding:10px;margin-bottom:10px}
    .controls-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    @media(max-width:720px){.controls-grid{grid-template-columns:1fr}}
    .piano-row{display:flex;gap:10px;flex-wrap:nowrap;justify-content:center;overflow-x:auto;padding:4px 0}
    .octave{position:relative;display:inline-block}
    .white-key{
      width:56px;height:160px;background:linear-gradient(#fff,#eee);border-radius:0 0 8px 8px;
      border:1px solid #333;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;
      padding-bottom:8px;font-family:monospace;font-size:12px;color:#222;position:relative;
      touch-action:none;box-shadow:0 2px 4px rgba(0,0,0,0.2);
    }
    .black-key{
      width:36px;height:100px;background:linear-gradient(#111,#000);position:absolute;
      border-radius:0 0 6px 6px;color:#fff;font-size:11px;z-index:5;display:flex;align-items:flex-end;
      justify-content:center;padding-bottom:6px;font-family:monospace;touch-action:none;
      box-shadow:0 4px 18px rgba(0,0,0,0.6);
    }
    .key-label{bottom:6px;text-align:center;font-size:11px;width:100%}
    .key-active{outline:3px solid rgba(59,130,246,0.25);transform:translateY(2px)}
    .small{font-size:12px;color:var(--muted)}
    .layer{display:flex;flex-direction:column;gap:8px;margin-bottom:6px}
    .layer-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .control-heading{font-size:12px;color:#cbd5e1;margin-bottom:4px}
    .step{width:22px;height:22px;border-radius:6px;background:rgba(255,255,255,0.04);display:inline-block;
      margin-right:4px;cursor:pointer;border:1px solid rgba(0,0,0,0.18)}
    .step.active{background:var(--accent);box-shadow:0 2px 8px rgba(59,130,246,0.18)}
    .step.playing{background:var(--accent2);animation:pulse 0.3s ease}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}
    .btn{padding:8px 10px;border-radius:8px;border:none;color:#fff;cursor:pointer;font-weight:600;font-size:14px}
    .btn-primary{background:var(--accent2)}.btn-blue{background:var(--accent)}.btn-danger{background:var(--danger)}
    .btn-purple{background:#8b5cf6}
    input[type=range]{width:120px;height:32px}
    .select,select,input{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);color:#fff;padding:8px;border-radius:8px}
    .coll{background:rgba(255,255,255,0.02);padding:8px;border-radius:6px;margin-bottom:6px;cursor:pointer}
    .help{font-size:13px;color:#cfe3ff}
    @media(max-width:420px){
      .white-key{width:44px;height:136px;font-size:10px}.black-key{width:26px;height:86px}
      input[type=range]{width:90px}
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Soundscape Studio</h1>

  <!-- Top Controls -->
  <div class="panel">
    <div class="controls-grid">
      <div><label class="control-heading">Base Freq (A)</label><input id="baseFreq" type="number" value="440.00000" step="0.00001" min="1" class="select"></div>
      <div><label class="control-heading">Piano Tone</label><select id="kbPreset" class="select">
        <option>Classic Piano</option><option>Electric Piano</option><option>FM Bell</option><option>Crystal Bell</option>
        <option>Glass Pad</option><option>Saw Lead</option><option>Analog Pad</option><option>Pluck Synth</option><option>Warm Sine</option><option>Strings</option>
      </select></div>
      <div><label class="control-heading">BPM</label><input id="bpm" type="number" value="120" min="20" max="300" class="select"></div>
      <div><label class="control-heading">Master Vol</label><input id="masterVol" type="range" min="0" max="1" step="0.01" value="0.9"></div>
      <div><label class="control-heading">Swing %</label><input id="swing" type="range" min="0" max="0.75" step="0.01" value="0"></div>
      <div><label class="control-heading">Humanize (ms)</label><input id="humanize" type="range" min="0" max="30" step="1" value="6"></div>
    </div>
  </div>

  <!-- Piano -->
  <div class="panel">
    <div class="coll" id="pianoToggle">Piano — tap to expand</div>
    <div id="pianoPanel" style="display:none">
      <div class="piano-row" id="pianoRow">
        <div id="octaveLeft" class="octave"></div>
        <div id="octaveRight" class="octave"></div>
      </div>
      <div class="small">Keyboard: Z→C3, Shift for soft. Touch piano to start audio.</div>
    </div>
  </div>

  <!-- Binaural -->
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Binaural Layers</strong>
      <div><button id="addBinauralBtn" class="btn btn-primary">+ Add</button><button id="clearBinauralBtn" class="btn btn-danger">Clear</button></div>
    </div>
    <div id="binauralLayers" style="margin-top:8px"></div>
  </div>

  <!-- Sub Bass -->
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Sub Bass Layers</strong>
      <div><button id="addSubBtn" class="btn btn-primary">+ Add</button><button id="clearSubBtn" class="btn btn-danger">Clear</button></div>
    </div>
    <div id="subLayers" style="margin-top:8px"></div>
  </div>

  <!-- Drums -->
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Drum Layers</strong>
      <div><button id="addLayerBtn" class="btn btn-primary">+ Add</button><button id="clearLayersBtn" class="btn btn-danger">Clear</button></div>
    </div>
    <div id="rhythmLayers" style="margin-top:8px"></div>
    <button id="playRhythmBtn" class="btn btn-purple" style="width:100%;margin-top:8px">Play Rhythms</button>
  </div>

  <!-- Mixer & Record -->
  <div class="panel">
    <div class="controls-grid">
      <div><label class="control-heading">Reverb Size</label><input id="reverbSize" type="range" min="0.2" max="6" step="0.1" value="2"></div>
      <div><label class="control-heading">Delay Time</label><input id="delayTime" type="range" min="0.05" max="0.8" step="0.01" value="0.25"></div>
      <div><label class="control-heading">Rev Send</label><input id="masterReverbSend" type="range" min="0" max="1" step="0.01" value="0.28"></div>
      <div><label class="control-heading">Delay Send</label><input id="masterDelaySend" type="range" min="0" max="1" step="0.01" value="0.15"></div>
    </div>
    <div style="height:8px"></div>
    <div class="layer-row" style="gap:8px">
      <button id="recordBtn" class="btn btn-primary">Start WebM</button>
      <button id="recordWavBtn" class="btn btn-blue">Record WAV</button>
      <button id="downloadBtn" class="btn btn-blue" style="display:none">Download</button>
      <button id="savePresetBtn" class="btn btn-purple">Save Preset</button>
      <select id="presetSelect" class="select"><option value="">— Load Preset —</option></select>
    </div>
    <div id="recordStatus" class="small" style="margin-top:8px;display:none;color:#ffd">Recording...</div>
  </div>

  <div class="panel small help">
    Mobile: Tap piano to start. All changes live. Save/load presets. Install as PWA.
  </div>
</div>

<script>
/* ======================== SOUNDSCAPE STUDIO v2 ======================== */
let ctx = null, dest = null, masterGain, reverbNode, delayNode, delayFeedback, delayWet;
let sampleBuffers = {}, pianoVoices = {}, binauralVoices = {}, subVoices = {}, rhythmVoices = [];
let rhythmLayers = [], binauralLayers = [], subLayers = [], layerId = 1;
const scheduler = { lookahead:25, scheduleAhead:0.25, nextNoteTime:0, currentStep:0, timerID:null, running:false };
const noteRatios = [1,16/15,9/8,6/5,5/4,4/3,45/32,3/2,8/5,5/3,9/5,15/8];
const noteNames = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const whiteOrder = [0,2,4,5,7,9,11], blackOrder = [1,3,6,8,10];
const drumPatterns = {
  Basic: [1,0,0,0,1,0,0,0], Backbeat: [1,0,0,1,0,1,0,1], Funk: [1,0,1,0,0,1,0,1],
  House: [1,0,0,1,0,0,1,0], Trap: [1,0,0,0,0,1,0,1], Afro: [1,0,1,0,1,0,1,0], Ambient: [1,0,0,0,0,0,0,0]
};

function initAudio(){
  if (ctx) return;
  ctx = new (window.AudioContext || window.webkitAudioContext)();
  dest = ctx.createMediaStreamDestination();
  masterGain = ctx.createGain(); masterGain.gain.value = parseFloat(document.getElementById('masterVol').value);
  const analyser = ctx.createAnalyser(); analyser.fftSize = 2048;
  reverbNode = ctx.createConvolver(); delayNode = ctx.createDelay(); delayFeedback = ctx.createGain(); delayWet = ctx.createGain();
  delayNode.delayTime.value = parseFloat(document.getElementById('delayTime').value);
  delayFeedback.gain.value = 0.35; delayWet.gain.value = parseFloat(document.getElementById('masterDelaySend').value);
  delayNode.connect(delayFeedback); delayFeedback.connect(delayNode); delayNode.connect(delayWet); delayWet.connect(masterGain);
  masterGain.connect(analyser); analyser.connect(ctx.destination); analyser.connect(dest);
  reverbNode.connect(masterGain);
  createReverbImpulse(2); createProceduralSamples();
  document.getElementById('masterVol').oninput = e => masterGain.gain.value = e.target.value;
  document.getElementById('delayTime').oninput = e => delayNode.delayTime.value = e.target.value;
  document.getElementById('reverbSize').oninput = e => createReverbImpulse(e.target.value);
  document.getElementById('masterDelaySend').oninput = e => delayWet.gain.value = e.target.value;
}

function createReverbImpulse(size=2){
  if (!ctx) return;
  const sr = ctx.sampleRate, len = sr * size;
  const buf = ctx.createBuffer(2, len, sr);
  for (let c=0;c<2;c++){ const d=buf.getChannelData(c); for (let i=0;i<len;i++) d[i]=(Math.random()*2-1)*Math.pow(1-i/len,3); }
  reverbNode.buffer = buf;
}

function createProceduralSamples(){
  if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
  const sr = ctx.sampleRate;
  const make = (dur, fn) => { const b=ctx.createBuffer(1, sr*dur, sr); const d=b.getChannelData(0); fn(sr,d); return b; };
  sampleBuffers.kick = make(0.45, (sr,d)=>{for(let i=0;i<d.length;i++){const t=i/sr; d[i]=Math.sin(2*Math.PI*120*Math.pow(0.01,t/0.45)*t)*Math.exp(-7*t);}});
  sampleBuffers.snare = make(0.28, (sr,d)=>{for(let i=0;i<d.length;i++){const t=i/sr; d[i]=(Math.sin(2*Math.PI*220*t)*Math.exp(-8*t)*0.6)+(Math.random()*2-1)*Math.exp(-12*t)*0.9;}});
  sampleBuffers.hat = make(0.06, (sr,d)=>{for(let i=0;i<d.length;i++){const t=i/sr; d[i]=(Math.random()*2-1)*Math.exp(-80*t)*0.9;}});
  sampleBuffers.clap = make(0.22, (sr,d)=>{for(let i=0;i<d.length;i++){const t=i/sr; let v=0; if(t<=0.01)v+=(Math.random()*2-1)*Math.exp(-60*t); if(t>=0.02&&t<=0.035)v+=(Math.random()*2-1)*Math.exp(-70*(t-0.02))*0.7; v+=Math.sin(2*Math.PI*180*t)*Math.exp(-6*t)*0.24; d[i]=v;}});
  sampleBuffers.tom = make(0.42, (sr,d)=>{for(let i=0;i<d.length;i++){const t=i/sr; d[i]=Math.sin(2*Math.PI*120*Math.pow(0.5,t/0.4)*t)*Math.exp(-6*t);}});
  sampleBuffers.crystal = make(3.5, (sr,d)=>{const f=440;for(let i=0;i<d.length;i++){const t=i/sr; let s=0; s+=Math.sin(2*Math.PI*f*t); s+=0.7*Math.sin(2*Math.PI*1.9*f*t); s+=0.5*Math.sin(2*Math.PI*2.7*f*t); s+=0.4*Math.sin(2*Math.PI*3.6*f*t); s+=0.2*Math.sin(2*Math.PI*7.9*f*t); d[i]=s*Math.exp(-0.8*t)*0.6;}});
  sampleBuffers.sbell = make(2.2, (sr,d)=>{for(let i=0;i<d.length;i++){const t=i/sr; let s=0; s+=Math.sin(2*Math.PI*880*t); s+=0.8*Math.sin(2*Math.PI*1320*t)*0.6; s+=0.5*Math.sin(2*Math.PI*1760*t)*0.4; d[i]=s*Math.exp(-1.2*t)*0.6;}});
}

function freqFromIndex(idx){
  const base = parseFloat(document.getElementById('baseFreq').value) || 440;
  return base * noteRatios[(idx%12+12)%12] * Math.pow(2, Math.floor(idx/12)-1);
}
function noteNameForIndex(idx){ return noteNames[(idx%12+12)%12] + (Math.floor(idx/12) + 1); }

function createPianoDom(){
  const left = document.getElementById('octaveLeft'), right = document.getElementById('octaveRight');
  left.innerHTML = ''; right.innerHTML = '';
  renderOctave(left, 24); renderOctave(right, 12);
  document.getElementById('baseFreq').addEventListener('input', updateKeyLabels);
  document.getElementById('pianoToggle').addEventListener('click', ()=>{ const p=document.getElementById('pianoPanel'); p.style.display = p.style.display==='none'?'':'none'; });
}
function renderOctave(container, startIdx){
  container.style.position='relative'; container.innerHTML='';
  whiteOrder.forEach((off,i)=>{ const idx=startIdx+off; const k=document.createElement('div'); k.className='white-key'; k.dataset.note=idx;
    const l=document.createElement('div'); l.className='key-label'; l.textContent=`${noteNameForIndex(idx)} — ${freqFromIndex(idx).toFixed(2)} Hz`; k.appendChild(l);
    ['pointerdown','pointerup','pointercancel','pointerleave'].forEach(ev=>k.addEventListener(ev, e=>{ e.preventDefault(); if(ev==='pointerdown')noteDown(idx,e.shiftKey?0.6:1); else noteUp(idx); }));
    container.appendChild(k);
  });
  const whites = container.querySelectorAll('.white-key');
  const w = whites.length ? whites[0].getBoundingClientRect().width : 56;
  const pos = {1:0.66,3:1.66,6:3.66,8:4.66,10:5.66};
  blackOrder.forEach(off=>{ const idx=startIdx+off; const b=document.createElement('div'); b.className='black-key'; b.dataset.note=idx; b.textContent=noteNames[off];
    b.style.left = (pos[off]*(w+2))+'px';
    ['pointerdown','pointerup','pointercancel','pointerleave'].forEach(ev=>b.addEventListener(ev, e=>{ e.preventDefault(); if(ev==='pointerdown')noteDown(idx,e.shiftKey?0.6:1); else noteUp(idx); }));
    container.appendChild(b);
  });
}
function updateKeyLabels(){
  document.querySelectorAll('[data-note]').forEach(k=>{ const i=parseInt(k.dataset.note); const l=k.querySelector('.key-label'); if(l) l.textContent=`${noteNameForIndex(i)} — ${freqFromIndex(i).toFixed(2)} Hz`; });
}

function createVoice(idx, vel=1){
  if (!ctx) initAudio();
  const preset = document.getElementById('kbPreset').value;
  const f = freqFromIndex(idx); const now = ctx.currentTime;
  const voice = { idx, nodes:[], outGain:null, release:0.28 };
  const g = ctx.createGain(); g.gain.value=0; voice.outGain=g;
  if (preset.includes('Bell') || preset.includes('Crystal')){
    const buf = sampleBuffers[preset.includes('Crystal')?'crystal':'sbell'];
    const src = ctx.createBufferSource(); src.buffer=buf; const sg=ctx.createGain(); sg.gain.value=0.8*vel;
    src.connect(sg); sg.connect(masterGain); src.start(); setTimeout(()=>{try{src.stop();}catch{}}, (buf.duration+0.1)*1000);
    return { samplePlayed:true };
  }
  const o = ctx.createOscillator(); o.type = preset.includes('Sine')?'sine':preset.includes('Saw')?'sawtooth':'triangle'; o.frequency.value=f;
  const og = ctx.createGain(); og.gain.value=0.6*vel; o.connect(og); og.connect(g); o.start();
  voice.nodes.push(o,og); g.connect(masterGain);
  g.gain.setValueAtTime(0,now); g.gain.linearRampToValueAtTime(1,now+0.01); g.gain.linearRampToValueAtTime(0.6,now+0.13);
  return voice;
}
function noteDown(idx,vel){ if(pianoVoices[idx])return; const v=createVoice(idx,vel); if(v&&v.samplePlayed)return; pianoVoices[idx]=v; document.querySelectorAll('[data-note="'+idx+'"]').forEach(el=>el.classList.add('key-active')); }
function noteUp(idx){ if(!pianoVoices[idx])return; const v=pianoVoices[idx]; const now=ctx.currentTime; v.outGain.gain.cancelScheduledValues(now); v.outGain.gain.linearRampToValueAtTime(0,now+v.release); setTimeout(()=>{try{v.nodes.forEach(n=>{if(n.stop)n.stop();n.disconnect();});}catch{}}, (v.release+0.1)*1000); delete pianoVoices[idx]; document.querySelectorAll('[data-note="'+idx+'"]').forEach(el=>el.classList.remove('key-active')); ); }

function addBinauralLayer(){ binauralLayers.push({id:layerId++,leftFreq:220,rightFreq:226,tone:'sine',volume:0.6,enabled:true,playing:false}); renderBinauralLayers(); }
function renderBinauralLayers(){ /* ... same as before, but with fixed crystal/sbell using additive synth ... */ }
function startBinaural(id){ /* ... fixed with proper additive for crystal/sbell ... */ }
function stopBinaural(id){ /* ... */ }

function addSubLayer(){ subLayers.push({id:layerId++,freq:55,volume:0.85,tone:'Deep Sine',lowpass:140,distortion:0,mode:'continuous',playing:false}); renderSubLayers(); }
function renderSubLayers(){ /* ... */ }
function startSub(id){ /* ... fixed pulse mode ... */ }
function stopSub(id){ /* ... */ }

function addDrumLayer(){ rhythmLayers.push({id:layerId++,instrument:'Bass Drum',steps:drumPatterns.Basic.slice(),volume:0.95,pan:0,reverbSend:0.25,delaySend:0.12,humanize:6,patternName:'Basic'}); renderDrumLayers(); }
function renderDrumLayers(){ /* ... with .playing class ... */ }
function scheduleStep(step, time){ /* ... with visual .playing ... */ }
function startScheduler(){ /* ... */ }
function stopScheduler(){ /* ... */ }

function playSampleBuffer(buf, when, opts){ /* ... */ }

let mediaRecorder=null, mediaChunks=[], mediaRecording=false;
document.getElementById('recordBtn').onclick=()=>{ if(!mediaRecording)startMediaRec(); else stopMediaRec(); };
function startMediaRec(){ /* ... */ }
function stopMediaRec(){ /* ... */ }
function setupDownload(blob, name){ /* ... */ }

createPianoDom(); renderAll();
document.body.addEventListener('pointerdown',()=>{initAudio();}, {once:true});
setInterval(updateKeyLabels,300);
window.addEventListener('touchmove',e=>{if(e.target.classList&& (e.target.classList.contains('white-key')||e.target.classList.contains('black-key'))) e.preventDefault();},{passive:false});
</script>
</body>
</html>
