<!doctype html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Mobile Tunable Piano Studio (min)</title><style>:root{--bg1:#071026;--bg2:#17428a;--panel:rgba(255,255,255,0.04);--muted:rgba(255,255,255,0.7);--acc:#3b82f6;--acc2:#10b981}*{box-sizing:border-box;margin:0;padding:0}html,body{height:100%}body{font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff;padding:10px;-webkit-user-select:none;user-select:none}h1{text-align:center;font-size:1.1rem;margin-bottom:8px} .container{max-width:1100px;margin:0 auto} .panel{background:var(--panel);border-radius:10px;padding:10px;margin-bottom:10px} .controls-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px} @media(max-width:720px){.controls-grid{grid-template-columns:1fr}} .select,select,input{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);color:#fff;padding:8px;border-radius:8px} .small{font-size:12px;color:var(--muted)} .piano-row{display:flex;gap:10px;justify-content:center;flex-wrap:nowrap} .octave{position:relative;display:inline-block} .white{width:52px;height:150px;background:linear-gradient(#fff,#eee);border-radius:0 0 8px 8px;border:1px solid #333;display:inline-flex;align-items:flex-end;justify-content:center;padding-bottom:6px;font-family:monospace;font-size:11px;color:#222;position:relative;margin-right:2px;touch-action:none} .black{width:32px;height:96px;background:linear-gradient(#111,#000);position:absolute;border-radius:0 0 6px 6px;color:#fff;font-size:11px;z-index:5;display:flex;align-items:flex-end;justify-content:center;padding-bottom:6px;touch-action:none} .label{position:absolute;bottom:6px;left:0;right:0;text-align:center;font-size:11px} .active{outline:3px solid rgba(59,130,246,0.2);transform:translateY(2px)} .layer{display:flex;flex-direction:column;gap:6px;margin-bottom:6px} .layer-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center} .control-heading{font-size:12px;color:#cbd5e1;margin-bottom:4px} .step{width:22px;height:22px;border-radius:6px;background:rgba(255,255,255,0.04);display:inline-block;margin-right:4px;cursor:pointer;border:1px solid rgba(0,0,0,0.18)} .step.active{background:var(--acc);box-shadow:0 2px 8px rgba(59,130,246,0.18)} .step.playing{background:var(--acc2)} .btn{padding:8px 10px;border-radius:8px;border:none;color:#fff;cursor:pointer;font-weight:600} .btn-primary{background:var(--acc2)} .btn-blue{background:var(--acc)} .btn-danger{background:#ef4444} .btn-purple{background:#8b5cf6} .coll{background:rgba(255,255,255,0.02);padding:8px;border-radius:6px;margin-bottom:6px;cursor:pointer} @media(max-width:420px){.white{width:42px;height:120px;font-size:10px}.black{width:26px;height:80px}}</style></head><body><div class="container"><h1>üéπ Tunable Piano Studio (minified)</h1><div class="panel"><div class="controls-grid"><div><label class="control-heading">Base Frequency (A tuning) ‚Äî Hz</label><input id="baseFreq" type="number" value="440.00000" step="0.00001" min="1" class="select"></div><div><label class="control-heading">Keyboard Tone Preset</label><select id="kbPreset" class="select"><option>Classic Piano</option><option>Electric Piano</option><option>FM Bell</option><option>Crystal Bell</option><option>Glass Pad</option><option>Saw Lead</option><option>Analog Pad</option><option>Pluck Synth</option><option>Warm Sine</option><option>Strings</option></select></div><div><label class="control-heading">BPM</label><input id="bpm" type="number" value="120" min="20" max="300" class="select"></div><div><label class="control-heading">Master Volume</label><input id="masterVol" type="range" min="0" max="1" step="0.01" value="0.9"></div><div><label class="control-heading">Swing (0‚Äì75%)</label><input id="swing" type="range" min="0" max="0.75" step="0.01" value="0"></div><div><label class="control-heading">Humanize (ms)</label><input id="humanize" type="range" min="0" max="30" step="1" value="6"></div></div></div><div class="panel"><div class="coll" id="pianoToggle">Piano ‚Äî tap to expand / collapse</div><div id="pianoPanel"><div class="piano-row" id="pianoRow"><div id="octaveLeft" class="octave"></div><div id="octaveRight" class="octave"></div></div><div style="height:8px"></div><div class="small">Keyboard: Z S X D C V G B H N J M ‚Üí C3 ‚Üí C4. Hold Shift for softer velocity.</div></div></div><div class="panel"><div style="display:flex;align-items:center;justify-content:space-between"><div><strong>Binaural Layers</strong></div><div><button id="addBinauralBtn" class="btn btn-primary">+ Add</button> <button id="clearBinauralBtn" class="btn btn-danger">Clear</button></div></div><div id="binauralLayers" style="margin-top:8px"></div></div><div class="panel"><div style="display:flex;align-items:center;justify-content:space-between"><div><strong>Sub Bass Layers</strong></div><div><button id="addSubBtn" class="btn btn-primary">+ Add</button> <button id="clearSubBtn" class="btn btn-danger">Clear</button></div></div><div id="subLayers" style="margin-top:8px"></div></div><div class="panel"><div style="display:flex;align-items:center;justify-content:space-between"><div><strong>Drum / Rhythm Layers</strong></div><div><button id="addLayerBtn" class="btn btn-primary">+ Add Layer</button> <button id="clearLayersBtn" class="btn btn-danger">Clear</button></div></div><div id="rhythmLayers" style="margin-top:8px"></div><div style="height:8px"></div><button id="playRhythmBtn" class="btn btn-purple" style="display:none;width:100%">‚ñ∂ Play Rhythms</button></div><div class="panel"><div class="controls-grid"><div><label class="control-heading">Reverb Size</label><input id="reverbSize" type="range" min="0.2" max="6" step="0.1" value="2"></div><div><label class="control-heading">Delay Time (s)</label><input id="delayTime" type="range" min="0.05" max="0.8" step="0.01" value="0.25"></div><div><label class="control-heading">Master Reverb Send</label><input id="masterReverbSend" type="range" min="0" max="1" step="0.01" value="0.28"></div><div><label class="control-heading">Master Delay Send</label><input id="masterDelaySend" type="range" min="0" max="1" step="0.01" value="0.15"></div></div><div style="height:8px"></div><div style="display:flex;gap:8px;flex-wrap:wrap"><button id="recordBtn" class="btn btn-primary">‚óè Start Recording (WebM)</button><button id="recordWavBtn" class="btn btn-blue">‚óè Record WAV</button><button id="downloadBtn" class="btn btn-blue" style="display:none">‚¨á Download</button><button id="savePresetBtn" class="btn btn-purple">üíæ Save Preset</button><select id="presetSelect" class="select"><option value="">‚Äî Load Preset ‚Äî</option></select></div><div id="recordStatus" style="margin-top:8px;display:none;color:#ffd" class="small">Recording...</div></div><div class="panel small" style="font-size:13px">Tips: Mobile-first, touch-playable keys, binaural L/R auto-routed. Volumes are gain-staged and limited to avoid surprises.</div></div><script>/* minified engine (compact) */let ctx=null,dest=null,masterGain,masterComp,masterAnalyser,reverbNode,delayNode,delayFb,delayWet;let sampleBuffers={};let pianoVoices={},binauralVoices={},subVoices={},rhythmLayers=[],binauralLayers=[],subLayers=[];let layerId=1;let scheduler={lookahead:25, scheduleAheadTime:0.25,nextNoteTime:0,currentStep:0,timerID:null,running:false};const noteRatios=[1,16/15,9/8,6/5,5/4,4/3,45/32,3/2,8/5,5/3,9/5,15/8];const noteNames=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];const whiteOrder=[0,2,4,5,7,9,11];const blackOrder=[1,3,6,8,10];const drumPatterns={Basic:[1,0,0,0,1,0,0,0],Backbeat:[1,0,0,1,0,1,0,1],Funk:[1,0,1,0,0,1,0,1],House:[1,0,0,1,0,0,1,0],Trap:[1,0,0,0,0,1,0,1],Afro:[1,0,1,0,1,0,1,0],Ambient:[1,0,0,0,0,0,0,0]};function initAudio(){if(ctx)return;ctx=new (window.AudioContext||window.webkitAudioContext)();dest=ctx.createMediaStreamDestination();masterGain=ctx.createGain();masterGain.gain.value=parseFloat(document.getElementById('masterVol').value||0.9);masterAnalyser=ctx.createAnalyser();masterAnalyser.fftSize=2048;reverbNode=ctx.createConvolver();delayNode=ctx.createDelay();delayNode.delayTime.value=parseFloat(document.getElementById('delayTime').value||0.25);delayFb=ctx.createGain();delayFb.gain.value=0.35;delayWet=ctx.createGain();delayWet.gain.value=parseFloat(document.getElementById('masterDelaySend').value||0.15);delayNode.connect(delayFb);delayFb.connect(delayNode);delayNode.connect(delayWet);delayWet.connect(masterGain);masterGain.connect(masterAnalyser);masterAnalyser.connect(ctx.destination);masterAnalyser.connect(dest);createReverbImpulse(parseFloat(document.getElementById('reverbSize').value||2));createSamples();setupMasterLimiter();document.getElementById('masterVol').addEventListener('input',e=>{if(masterGain)masterGain.gain.value=parseFloat(e.target.value)});document.getElementById('delayTime').addEventListener('input',e=>{if(delayNode)delayNode.delayTime.value=parseFloat(e.target.value)});document.getElementById('reverbSize').addEventListener('input',e=>createReverbImpulse(parseFloat(e.target.value)));document.getElementById('masterDelaySend').addEventListener('input',e=>{if(delayWet)delayWet.gain.value=parseFloat(e.target.value)})}function setupMasterLimiter(){// gentle compressor to stabilize loudness if supported try{masterComp=ctx.createDynamicsCompressor();masterComp.threshold.value=-6;masterComp.knee.value=12;masterComp.ratio.value=3;masterComp.attack.value=0.02;masterComp.release.value=0.15;masterGain.disconnect();masterGain.connect(masterComp);masterComp.connect(ctx.destination);masterComp.connect(dest);}catch(e){console.warn('no comp',e)}}function createReverbImpulse(size=2){if(!ctx)return;const sr=ctx.sampleRate;const len=Math.floor(sr*size);const buf=ctx.createBuffer(2,len,sr);for(let c=0;c<2;c++){const ch=buf.getChannelData(c);for(let i=0;i<len;i++)ch[i]=(Math.random()*2-1)*Math.pow(1-i/len,3)}reverbNode.buffer=buf}function createSamples(){if(!ctx)ctx=new (window.AudioContext||window.webkitAudioContext)();sampleBuffers.kick=mk(0.45,(sr,d)=>{for(let i=0;i<d.length;i++){const t=i/sr;const env=Math.exp(-7*t);const f=120*Math.pow(0.01,t/0.45);d[i]=Math.sin(2*Math.PI*f*t)*env}for(let i=0;i<Math.min(sr*0.003,d.length);i++)d[i]+=(Math.random()*2-1)*0.6*Math.exp(-i/100)});sampleBuffers.snare=mk(0.28,(sr,d)=>{for(let i=0;i<d.length;i++){const t=i/sr;const body=Math.sin(2*Math.PI*220*t)*Math.exp(-8*t)*0.6;const n=(Math.random()*2-1)*Math.exp(-12*t)*0.9;d[i]=body+n*0.8}let p=0;for(let i=0;i<d.length;i++){const c=d[i];d[i]=c-p*0.995;p=c}});sampleBuffers.hat=mk(0.06,(sr,d)=>{for(let i=0;i<d.length;i++){const t=i/sr;let s=(Math.random()*2-1)*Math.exp(-80*t);if(i>0)s-=d[i-1]*0.4;d[i]=s*0.9}});sampleBuffers.clap=mk(0.22,(sr,d)=>{for(let i=0;i<d.length;i++){const t=i/sr;let v=0;if(t<=0.01)v+=(Math.random()*2-1)*Math.exp(-60*t);if(t>=0.02&&t<=0.035)v+=(Math.random()*2-1)*Math.exp(-70*(t-0.02))*0.7;v+=Math.sin(2*Math.PI*180*t)*Math.exp(-6*t)*0.24;d[i]=v}});sampleBuffers.tom=mk(0.42,(sr,d)=>{for(let i=0;i<d.length;i++){const t=i/sr;d[i]=Math.sin(2*Math.PI*(120*Math.pow(0.5,t/0.4))*t)*Math.exp(-6*t)+(Math.random()*2-1)*0.02}});sampleBuffers.crystal=mk(3.2,(sr,d)=>{const base=440;for(let i=0;i<d.length;i++){const t=i/sr;let s=0;const env=Math.exp(-0.8*t);s+=Math.sin(2*Math.PI*base*t);s+=0.7*Math.sin(2*Math.PI*1.9*base*t+0.1)*0.8;s+=0.5*Math.sin(2*Math.PI*2.7*base*t+0.2)*0.6;s+=0.4*Math.sin(2*Math.PI*3.6*base*t+0.3)*0.5;s+=0.2*Math.sin(2*Math.PI*7.9*base*t)*0.2;d[i]=s*env*0.6}let p=0;for(let i=0;i<d.length;i++){const c=d[i];d[i]=c-p*0.996;p=c}});sampleBuffers.sbell=mk(2.2,(sr,d)=>{for(let i=0;i<d.length;i++){const t=i/sr;const env=Math.exp(-1.2*t);let s=0;s+=Math.sin(2*Math.PI*880*t);s+=0.8*Math.sin(2*Math.PI*1320*t)*0.6;s+=0.5*Math.sin(2*Math.PI*1760*t)*0.4;d[i]=s*env*0.6}let p=0;for(let i=0;i<d.length;i++){const c=d[i];d[i]=c-p*0.995;p=c}});normalizeAll()}function mk(dur,fn){const sr=ctx.sampleRate||44100;const len=Math.floor(dur*sr);const b=ctx.createBuffer(1,len,sr);const ch=b.getChannelData(0);fn(sr,ch);return b}function normalizeAll(){for(const k in sampleBuffers){const b=sampleBuffers[k];const d=b.getChannelData(0);let peak=0;for(let i=0;i<d.length;i++){peak=Math.max(peak,Math.abs(d[i]))}if(peak>0){const gain=1/peak*0.9;for(let i=0;i<d.length;i++)d[i]*=gain}}}function freqFromIndex(idx){const base=parseFloat(document.getElementById('baseFreq').value)||440;return base*noteRatios[(idx%12+12)%12]*Math.pow(2,Math.floor(idx/12)-1)}function nameFor(idx){return noteNames[(idx%12+12)%12]+(Math.floor(idx/12)+1)}/* piano DOM */function createPiano(){const L=document.getElementById('octaveLeft'),R=document.getElementById('octaveRight');L.innerHTML='';R.innerHTML='';renderOct(L,24);renderOct(R,12);document.getElementById('baseFreq').addEventListener('input',updateLabels);document.getElementById('pianoToggle').addEventListener('click',()=>{const p=document.getElementById('pianoPanel');p.style.display=p.style.display==='none'?'':'none'})}function renderOct(container,start){container.style.position='relative';container.innerHTML='';whiteOrder.forEach(n=>{const idx=start+n;const w=document.createElement('div');w.className='white';w.dataset.note=idx;const lbl=document.createElement('div');lbl.className='label';lbl.textContent=`${nameFor(idx)} ‚Äî ${freqFromIndex(idx).toFixed(2)} Hz`;w.appendChild(lbl);w.addEventListener('pointerdown',e=>{e.preventDefault();noteDown(idx,e.shiftKey?0.6:1)});w.addEventListener('pointerup',e=>{e.preventDefault();noteUp(idx)});w.addEventListener('pointercancel',()=>noteUp(idx));w.addEventListener('pointerleave',()=>noteUp(idx));container.appendChild(w)});const whites=container.querySelectorAll('.white');let wW=(whites[0]&&whites[0].getBoundingClientRect)?whites[0].getBoundingClientRect().width:52; if(!wW||wW<10)wW=52;const posMap={1:0.66,3:1.66,6:3.66,8:4.66,10:5.66};blackOrder.forEach(n=>{const idx=start+n;const b=document.createElement('div');b.className='black';b.dataset.note=idx;b.textContent=noteNames[n];const pos=(posMap[n]||0)*(wW+2);b.style.left=pos+'px';b.addEventListener('pointerdown',e=>{e.preventDefault();noteDown(idx,e.shiftKey?0.6:1)});b.addEventListener('pointerup',e=>{e.preventDefault();noteUp(idx)});b.addEventListener('pointercancel',()=>noteUp(idx));container.appendChild(b)})}function updateLabels(){document.querySelectorAll('[data-note]').forEach(k=>{const idx=parseInt(k.dataset.note);const l=k.querySelector('.label');if(l)l.textContent=`${nameFor(idx)} ‚Äî ${freqFromIndex(idx).toFixed(2)} Hz`})}/* voices */function createVoice(idx,vel=1){if(!ctx) initAudio();const now=ctx.currentTime;const preset=document.getElementById('kbPreset').value||'Classic Piano';const voice={idx,nodes:[],out:ctx.createGain(),release:0.28};voice.out.gain.value=0;let f=freqFromIndex(idx);if(preset==='Classic Piano'){const o1=ctx.createOscillator(),o2=ctx.createOscillator(),o3=ctx.createOscillator();o1.type='triangle';o2.type='triangle';o3.type='sine';o1.frequency.value=f;o2.frequency.value=f*1.003;o3.frequency.value=f*2;const m=ctx.createGain();m.gain.value=0.6*vel;o1.connect(m);o2.connect(m);o3.connect(m);m.connect(voice.out);o1.start(now);o2.start(now);o3.start(now);voice.nodes.push(o1,o2,o3,m);voice.release=0.28}else if(preset==='Electric Piano'){const car=ctx.createOscillator(),mod=ctx.createOscillator(),mg=ctx.createGain();car.type='sine';car.frequency.value=f;mod.type='sine';mod.frequency.value=5;mg.gain.value=f*0.003;mod.connect(mg);mg.connect(car.frequency);const m=ctx.createGain();m.gain.value=0.7*vel;car.connect(m);m.connect(voice.out);car.start(now);mod.start(now);voice.nodes.push(car,mod,mg,m);voice.release=0.35}else if(preset==='FM Bell'||preset==='Crystal Bell'||preset==='Sustained Bell'){// sample-based immediate play (handled separately)playPianoSample(preset,f,vel);return null}else{const o=ctx.createOscillator();o.type=(preset==='Warm Sine')?'sine':(preset==='Saw Lead'?'sawtooth':'triangle');o.frequency.value=f;const g=ctx.createGain();g.gain.value=0.6*vel;o.connect(g);g.connect(voice.out);o.start(now);voice.nodes.push(o,g);voice.release=0.5}voice.out.connect(masterGain);voice.out.gain.setValueAtTime(0,now);voice.out.gain.linearRampToValueAtTime(1,now+0.01);voice.out.gain.linearRampToValueAtTime(0.6,now+0.01+0.12);return voice}function playPianoSample(type,f,vel){if(type.toLowerCase().includes('crystal')){const buf=sampleBuffers.crystal;const src=ctx.createBufferSource();src.buffer=buf;const g=ctx.createGain();g.gain.value=0.6*vel;src.connect(g);g.connect(masterGain);src.playbackRate.value=f/440;src.start();setTimeout(()=>{try{src.stop()}catch(e){}},(buf.duration/src.playbackRate.value+0.05)*1000)}else if(type.toLowerCase().includes('sustain')){const buf=sampleBuffers.sbell;const src=ctx.createBufferSource();src.buffer=buf;const g=ctx.createGain();g.gain.value=0.6*vel;src.connect(g);g.connect(masterGain);src.playbackRate.value=f/880;src.start();setTimeout(()=>{try{src.stop()}catch(e){}},(buf.duration/src.playbackRate.value+0.05)*1000)} }function stopVoice(idx){const v=pianoVoices[idx];if(!v)return;try{const now=ctx.currentTime;v.out.gain.cancelScheduledValues(now);v.out.gain.setValueAtTime(v.out.gain.value,now);const rel=v.release||0.28;v.out.gain.linearRampToValueAtTime(0,now+rel);setTimeout(()=>{try{v.nodes.forEach(n=>{if(n.stop)try{n.stop()}catch(e){};if(n.disconnect)try{n.disconnect()}catch(e){}})}catch(e){}},(rel+0.05)*1000)}catch(e){console.warn(e)}delete pianoVoices[idx]}function noteDown(idx,vel=1){if(!ctx) initAudio();if(pianoVoices[idx])return;const v=createVoice(idx,vel);if(!v)return;v.out.connect(masterGain);pianoVoices[idx]=v;document.querySelectorAll('[data-note="'+idx+'"]').forEach(el=>el.classList.add('active'))}function noteUp(idx){if(!pianoVoices[idx])return;stopVoice(idx);document.querySelectorAll('[data-note="'+idx+'"]').forEach(el=>el.classList.remove('active'))}/* binaural */function addBinaural(){binauralLayers.push({id:layerId++,leftFreq:220,rightFreq:226,tone:'sine',volume:0.6,playing:false});renderBinaural()}function renderBinaural(){const c=document.getElementById('binauralLayers');c.innerHTML='';if(binauralLayers.length===0){c.innerHTML='<p class=\"small\">No binaural layers</p>';return;}binauralLayers.forEach(L=>{const wrap=document.createElement('div');wrap.className='layer';const row=document.createElement('div');row.className='layer-row';const lf=document.createElement('input');lf.type='number';lf.value=L.leftFreq;lf.oninput=()=>{L.leftFreq=parseFloat(lf.value);if(binauralVoices[L.id])binauralVoices[L.id].left.frequency.setValueAtTime(L.leftFreq,ctx.currentTime)};const rf=document.createElement('input');rf.type='number';rf.value=L.rightFreq;rf.oninput=()=>{L.rightFreq=parseFloat(rf.value);if(binauralVoices[L.id])binauralVoices[L.id].right.frequency.setValueAtTime(L.rightFreq,ctx.currentTime)};const tone=document.createElement('select');['sine','triangle','crystal bowl','sustained bell','noise pad'].forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;if(L.tone===t)o.selected=true;tone.appendChild(o)});tone.onchange=()=>{L.tone=tone.value;if(binauralVoices[L.id]){stopBinaural(L.id);startBinaural(L.id);}};const vol=document.createElement('input');vol.type='range';vol.min=0;vol.max=1;vol.step=0.01;vol.value=L.volume;vol.oninput=()=>{L.volume=parseFloat(vol.value);if(binauralVoices[L.id]){const v=binauralVoices[L.id];if(v.gainL)v.gainL.gain.value=L.volume; if(v.gainR)v.gainR.gain.value=L.volume}};const play=document.createElement('button');play.className='btn btn-blue';play.textContent=L.playing?'Stop':'Play';play.onclick=()=>{if(L.playing){stopBinaural(L.id);L.playing=false}else{startBinaural(L.id);L.playing=true}renderBinaural()};const rem=document.createElement('button');rem.className='btn btn-danger';rem.textContent='‚úï';rem.onclick=()=>{if(confirm('Remove binaural?')){stopBinaural(L.id);binauralLayers=binauralLayers.filter(x=>x.id!==L.id);renderBinaural()}};row.appendChild(lf);row.appendChild(rf);row.appendChild(tone);row.appendChild(vol);row.appendChild(play);row.appendChild(rem);wrap.appendChild(row);c.appendChild(wrap)})}function startBinaural(id){const L=binauralLayers.find(x=>x.id===id);if(!L)return;if(!ctx) initAudio();const now=ctx.currentTime; if(L.tone==='crystal bowl'||L.tone==='sustained bell'){// rich synthesized partials per ear const left=ctx.createOscillator(),right=ctx.createOscillator();left.type='sine';right.type='sine';left.frequency.setValueAtTime(L.leftFreq,now);right.frequency.setValueAtTime(L.rightFreq,now);const gainL=ctx.createGain(),gainR=ctx.createGain();gainL.gain.value=L.volume;gainR.gain.value=L.volume;const pL=ctx.createStereoPanner(),pR=ctx.createStereoPanner();pL.pan.value=-1;pR.pan.value=1;left.connect(gainL);right.connect(gainR);gainL.connect(pL);gainR.connect(pR);pL.connect(masterGain);pR.connect(masterGain);left.start(now);right.start(now);binauralVoices[id]={left,right,gainL,gainR,pL,pR,type:L.tone};return}if(L.tone==='noise pad'){const buf=ctx.createBuffer(1,ctx.sampleRate*2,ctx.sampleRate);const d=buf.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.exp(-i/d.length*2);const sL=ctx.createBufferSource(),sR=ctx.createBufferSource();sL.buffer=buf;sR.buffer=buf;sL.loop=true;sR.loop=true;const gL=ctx.createGain(),gR=ctx.createGain();gL.gain.value=L.volume;gR.gain.value=L.volume;const pL=ctx.createStereoPanner(),pR=ctx.createStereoPanner();pL.pan.value=-1;pR.pan.value=1;sL.connect(gL);gL.connect(pL);pL.connect(masterGain);sR.connect(gR);gR.connect(pR);pR.connect(masterGain);sL.start(now);sR.start(now);binauralVoices[id]={left:sL,right:sR,gainL:gL,gainR:gR,pL,pR,type:'noise'};return} // default oscillators const left=ctx.createOscillator(),right=ctx.createOscillator();left.type=(L.tone==='triangle')?'triangle':'sine';right.type=(L.tone==='triangle')?'triangle':'sine';left.frequency.setValueAtTime(L.leftFreq,now);right.frequency.setValueAtTime(L.rightFreq,now);const gL=ctx.createGain(),gR=ctx.createGain();gL.gain.value=L.volume;gR.gain.value=L.volume;const pL=ctx.createStereoPanner(),pR=ctx.createStereoPanner();pL.pan.value=-1;pR.pan.value=1;left.connect(gL);gL.connect(pL);pL.connect(masterGain);right.connect(gR);gR.connect(pR);pR.connect(masterGain);left.start(now);right.start(now);binauralVoices[id]={left,right,gainL:gL,gainR:gR,pL,pR,type:L.tone}}function stopBinaural(id){const v=binauralVoices[id];if(!v)return;try{if(v.left&&v.left.stop)try{v.left.stop()}catch(e){};if(v.right&&v.right.stop)try{v.right.stop()}catch(e){};if(v.gainL)v.gainL.disconnect();if(v.gainR)v.gainR.disconnect();if(v.pL)v.pL.disconnect();if(v.pR)v.pR.disconnect();if(v.left&&v.left.disconnect)try{v.left.disconnect()}catch(e){};if(v.right&&v.right.disconnect)try{v.right.disconnect()}catch(e){} }catch(e){}delete binauralVoices[id]}/* sub bass */function addSub(){subLayers.push({id:layerId++,freq:55,volume:0.85,tone:'Deep Sine',lowpass:140,dist:0,mode:'continuous',playing:false});renderSub()}function renderSub(){const c=document.getElementById('subLayers');c.innerHTML='';if(subLayers.length===0){c.innerHTML='<p class=\"small\">No sub layers</p>';return;}subLayers.forEach(s=>{const wrap=document.createElement('div');wrap.className='layer';const row=document.createElement('div');row.className='layer-row';const fin=document.createElement('input');fin.type='number';fin.value=s.freq;fin.oninput=()=>{s.freq=parseFloat(fin.value);if(subVoices[s.id]&&subVoices[s.id].osc)subVoices[s.id].osc.frequency.setValueAtTime(s.freq,ctx.currentTime)};const tsel=document.createElement('select');['Deep Sine','Electric Bass','Sub Pad','Reece Bass'].forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;if(s.tone===t)o.selected=true;tsel.appendChild(o)});tsel.onchange=()=>{s.tone=tsel.value;if(subVoices[s.id]){stopSub(s.id);startSub(s.id)}};const vold=document.createElement('input');vold.type='range';vold.min=0;vold.max=1;vold.step=0.01;vold.value=s.volume;vold.oninput=()=>{s.volume=parseFloat(vold.value);if(subVoices[s.id])subVoices[s.id].gain.gain.value=s.volume};const lp=document.createElement('input');lp.type='range';lp.min=40;lp.max=400;lp.step=1;lp.value=s.lowpass;lp.oninput=()=>{s.lowpass=parseFloat(lp.value);if(subVoices[s.id]&&subVoices[s.id].filter)subVoices[s.id].filter.frequency.value=s.lowpass};const mode=document.createElement('select');['continuous','pulse'].forEach(m=>{const o=document.createElement('option');o.value=m;o.textContent=m;if(s.mode===m)o.selected=true;mode.appendChild(o)});mode.onchange=()=>{s.mode=mode.value;if(subVoices[s.id]){stopSub(s.id);startSub(s.id)}};const play=document.createElement('button');play.className='btn btn-blue';play.textContent=subVoices[s.id]?'Stop':'Play';play.onclick=()=>{if(subVoices[s.id]){stopSub(s.id)}else{startSub(s.id)}renderSub()};const rem=document.createElement('button');rem.className='btn btn-danger';rem.textContent='‚úï';rem.onclick=()=>{if(confirm('Remove sub?')){stopSub(s.id);subLayers=subLayers.filter(x=>x.id!==s.id);renderSub()}};row.appendChild(fin);row.appendChild(tsel);row.appendChild(vold);row.appendChild(lp);row.appendChild(mode);row.appendChild(play);row.appendChild(rem);wrap.appendChild(row);c.appendChild(wrap)})}function startSub(id){const s=subLayers.find(x=>x.id===id);if(!s)return;if(!ctx) initAudio();const now=ctx.currentTime;if(s.tone==='Deep Sine'||s.tone==='Sub Pad'){const osc=ctx.createOscillator();osc.type='sine';osc.frequency.value=s.freq;const gain=ctx.createGain();gain.gain.value=s.volume;const filter=ctx.createBiquadFilter();filter.type='lowpass';filter.frequency.value=s.lowpass;osc.connect(filter);filter.connect(gain);gain.connect(masterGain);osc.start(now);subVoices[id]={osc,gain,filter}}else if(s.tone==='Electric Bass'){const o1=ctx.createOscillator(),o2=ctx.createOscillator();o1.type='sine';o2.type='sawtooth';o1.frequency.value=s.freq;o2.frequency.value=s.freq*2;const g1=ctx.createGain(),g2=ctx.createGain();g1.gain.value=0.9*s.volume;g2.gain.value=0.2*s.volume;const filter=ctx.createBiquadFilter();filter.type='lowpass';filter.frequency.value=s.lowpass;o1.connect(g1);o2.connect(g2);g1.connect(filter);g2.connect(filter);filter.connect(masterGain);o1.start(now);o2.start(now);subVoices[id]={osc1:o1,osc2:o2,g1,g2,filter}}else if(s.tone==='Reece Bass'){const o1=ctx.createOscillator(),o2=ctx.createOscillator();o1.type='sawtooth';o2.type='sawtooth';o1.frequency.value=s.freq;o2.frequency.value=s.freq*1.01;const g1=ctx.createGain(),g2=ctx.createGain();g1.gain.value=0.5*s.volume;g2.gain.value=0.5*s.volume;const filter=ctx.createBiquadFilter();filter.type='lowpass';filter.frequency.value=s.lowpass;o1.connect(g1);o2.connect(g2);g1.connect(filter);g2.connect(filter);filter.connect(masterGain);o1.start(now);o2.start(now);subVoices[id]={osc1:o1,osc2:o2,g1,g2,filter}}if(s.mode==='pulse'){const bpm=parseFloat(document.getElementById('bpm').value)||120;const intMs=(60/bpm)*1000;subVoices[id].pulse=setInterval(()=>{const g=subVoices[id].gain||subVoices[id].g1; if(!g)return; g.gain.cancelScheduledValues(ctx.currentTime); g.gain.setValueAtTime(0,ctx.currentTime); g.gain.linearRampToValueAtTime(s.volume,ctx.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+intMs/1000*0.5)},intMs)}function stopSub(id){const v=subVoices[id];if(!v)return;try{if(v.osc)try{v.osc.stop()}catch(e){};if(v.osc1)try{v.osc1.stop()}catch(e){};if(v.osc2)try{v.osc2.stop()}catch(e){};if(v.gain)try{v.gain.disconnect()}catch(e){};if(v.g1)try{v.g1.disconnect()}catch(e){};if(v.g2)try{v.g2.disconnect()}catch(e){};if(v.filter)try{v.filter.disconnect()}catch(e){};if(v.pulse)clearInterval(v.pulse)}catch(e){}delete subVoices[id]}/* drums */function addDrum(){rhythmLayers.push({id:layerId++,instrument:'Bass Drum',steps:drumPatterns.Basic.slice(),enabled:true,volume:0.95,pan:0,reverbSend:0.25,delaySend:0.12,humanize:6,patternName:'Basic'});renderDrums()}function renderDrums(){const c=document.getElementById('rhythmLayers');c.innerHTML='';if(rhythmLayers.length===0){c.innerHTML='<p class=\"small\">Add drum layers</p>';document.getElementById('playRhythmBtn').style.display='none';return}document.getElementById('playRhythmBtn').style.display='block';rhythmLayers.forEach(layer=>{const wrap=document.createElement('div');wrap.className='layer';const top=document.createElement('div');top.className='layer-row';const inst=document.createElement('select');['Bass Drum','Snare','Hi-Hat','Clap','Tom','Shaker'].forEach(i=>{const o=document.createElement('option');o.value=i;o.textContent=i;if(layer.instrument===i)o.selected=true;inst.appendChild(o)});inst.onchange=()=>layer.instrument=inst.value;const pat=document.createElement('select');Object.keys(drumPatterns).forEach(p=>{const o=document.createElement('option');o.value=p;o.textContent=p;if(layer.patternName===p)o.selected=true;pat.appendChild(o)});pat.onchange=()=>{layer.patternName=pat.value;layer.steps=drumPatterns[pat.value].slice();renderDrums()};const vol=document.createElement('input');vol.type='range';vol.min=0;vol.max=1;vol.step=0.01;vol.value=layer.volume;vol.oninput=()=>layer.volume=parseFloat(vol.value);const pan=document.createElement('input');pan.type='range';pan.min=-1;pan.max=1;pan.step=0.01;pan.value=layer.pan||0;pan.oninput=()=>layer.pan=parseFloat(pan.value);const rev=document.createElement('input');rev.type='range';rev.min=0;rev.max=1;rev.step=0.01;rev.value=layer.reverbSend;rev.oninput=()=>layer.reverbSend=parseFloat(rev.value);const d=document.createElement('input');d.type='range';d.min=0;d.max=1;d.step=0.01;d.value=layer.delaySend;d.oninput=()=>layer.delaySend=parseFloat(d.value);const hum=document.createElement('input');hum.type='range';hum.min=0;hum.max=40;hum.step=1;hum.value=layer.humanize;hum.oninput=()=>layer.humanize=parseInt(hum.value);const mute=document.createElement('button');mute.className='btn btn-danger';mute.textContent=layer.enabled?'Mute':'Unmute';mute.onclick=()=>{layer.enabled=!layer.enabled;renderDrums()};const rem=document.createElement('button');rem.className='btn btn-danger';rem.textContent='‚úï';rem.onclick=()=>{if(confirm('Remove layer?')){rhythmLayers=rhythmLayers.filter(x=>x.id!==layer.id);renderDrums()}};top.appendChild(inst);top.appendChild(pat);top.appendChild(vol);top.appendChild(pan);top.appendChild(rev);top.appendChild(d);top.appendChild(hum);top.appendChild(mute);top.appendChild(rem);const steps=document.createElement('div');steps.style.display='flex';layer.steps.forEach((s,i)=>{const el=document.createElement('div');el.className='step'+(s?' active':'');el.onclick=()=>{layer.steps[i]=layer.steps[i]?0:1;renderDrums()};steps.appendChild(el)});wrap.appendChild(top);wrap.appendChild(steps);c.appendChild(wrap)})}function playBuffer(buf,when,opts={}){if(!ctx) initAudio();const src=ctx.createBufferSource();src.buffer=buf;src.playbackRate.value=opts.playbackRate||1;const g=ctx.createGain();g.gain.value=opts.gain||1;const p=ctx.createStereoPanner();p.pan.value=opts.pan||0;const r=ctx.createGain();r.gain.value=(opts.reverbSend||0)*parseFloat(document.getElementById('masterReverbSend').value||1);const d=ctx.createGain();d.gain.value=(opts.delaySend||0)*parseFloat(document.getElementById('masterDelaySend').value||1);src.connect(g);g.connect(p);p.connect(masterGain);g.connect(r);r.connect(reverbNode);g.connect(d);d.connect(delayNode);d.connect(delayWet);src.start(when);const dur=buf.duration/(src.playbackRate.value||1);setTimeout(()=>{try{src.stop()}catch(e){};try{src.disconnect();g.disconnect();p.disconnect();r.disconnect();d.disconnect()}catch(e){}},(when-ctx.currentTime+dur+0.05)*1000);return src}function scheduleStep(step,time){const swing=parseFloat(document.getElementById('swing').value)||0;rhythmLayers.forEach(layer=>{if(!layer.enabled)return;const idx=step%layer.steps.length;if(!layer.steps[idx])return;let when=time; if(idx%2===1&&swing>0&&layer.steps.length%2===0){const bpm=parseFloat(document.getElementById('bpm').value)||120;const base=(60/bpm)*(4/layer.steps.length);when+=base*swing}const h=layer.humanize||parseFloat(document.getElementById('humanize').value)||0;when+=((Math.random()*2-1)*(h/1000));let buf=sampleBuffers.kick; if(layer.instrument==='Snare')buf=sampleBuffers.snare;else if(layer.instrument==='Hi-Hat')buf=sampleBuffers.hat;else if(layer.instrument==='Clap')buf=sampleBuffers.clap;else if(layer.instrument==='Tom')buf=sampleBuffers.tom;else if(layer.instrument==='Shaker')buf=sampleBuffers.hat;playBuffer(buf,when,{gain:layer.volume,pan:layer.pan,reverbSend:layer.reverbSend,delaySend:layer.delaySend})})}function schedLoop(){while(scheduler.nextNoteTime<ctx.currentTime+scheduler.scheduleAheadTime){scheduleStep(scheduler.currentStep,scheduler.nextNoteTime);scheduler.nextNoteTime+=0.25*(60/(parseFloat(document.getElementById('bpm').value)||120));scheduler.currentStep=(scheduler.currentStep+1)%16}scheduler.timerID=setTimeout(schedLoop,scheduler.lookahead)}function startSched(){if(!ctx) initAudio();if(scheduler.running)return;scheduler.nextNoteTime=ctx.currentTime+0.05;scheduler.currentStep=0;scheduler.running=true;schedLoop();document.getElementById('playRhythmBtn').textContent='‚ñ† Stop Rhythms'}function stopSched(){if(!scheduler.running)return;clearTimeout(scheduler.timerID);scheduler.running=false;document.getElementById('playRhythmBtn').textContent='‚ñ∂ Play Rhythms'}/* UI wiring and initial render */createPiano();renderBinaural();renderSub();renderDrums();document.getElementById('addLayerBtn').addEventListener('click',addDrum);document.getElementById('playRhythmBtn').addEventListener('click',()=>{if(!ctx) initAudio();if(scheduler.running)stopSched();else startSched()});document.getElementById('addBinauralBtn').addEventListener('click',addBinaural);document.getElementById('clearBinauralBtn').addEventListener('click',()=>{if(confirm('Clear binaural layers?')){Object.keys(binauralVoices).forEach(k=>stopBinaural(Number(k)));binauralLayers=[];renderBinaural()}});document.getElementById('addSubBtn').addEventListener('click',addSub);document.getElementById('clearSubBtn').addEventListener('click',()=>{if(confirm('Clear sub layers?')){Object.keys(subVoices).forEach(k=>stopSub(Number(k)));subLayers=[];renderSub()}});document.getElementById('addBinauralBtn').addEventListener('click',addBinaural);document.getElementById('clearLayersBtn').addEventListener('click',()=>{if(confirm('Clear drum layers?')){rhythmLayers=[];renderDrums()}});document.getElementById('addLayerBtn').addEventListener('click',addDrum);document.body.addEventListener('pointerdown',function initOnce(){initAudio();document.body.removeEventListener('pointerdown',initOnce)});setInterval(updateLabels,300);window.addEventListener('touchmove',function(e){const t=e.target;if(t&&t.classList&& (t.classList.contains('white')||t.classList.contains('black'))){e.preventDefault()}},{passive:false});</script></body></html>
